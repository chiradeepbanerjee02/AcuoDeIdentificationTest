---
name: DeIdentification Tests

on:
  push:
    branches:
      - main1
      - master
  pull_request:
    branches:
      - main1
      - master
  workflow_dispatch:

jobs:
  test:
    name: Execute DeIdentification Tests
    runs-on: ['self-hosted', 'Windows', 'X64']
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install AcuoDeIdentification
        shell: pwsh
        run: |
          Write-Host "Installing AcuoDeIdentification..." -ForegroundColor Cyan

          # Check if running as administrator
          $currentPrincipal = [Security.Principal.WindowsPrincipal] `
            [Security.Principal.WindowsIdentity]::GetCurrent()
          $isAdmin = $currentPrincipal.IsInRole( `
            [Security.Principal.WindowsBuiltInRole]::Administrator)

          if (-not $isAdmin) {
            Write-Host "ERROR: Requires administrator privileges" `
              -ForegroundColor Red
            Write-Host `
              "Please configure the runner to run as administrator" `
              -ForegroundColor Yellow
            Write-Host `
              "See: https://docs.github.com/actions" `
              -ForegroundColor Yellow
            exit 1
          }

          Write-Host "Running with administrator privileges" `
            -ForegroundColor Green
          & "$env:GITHUB_WORKSPACE\Install-DeIdentification.ps1"

      - name: Run Pre-Requisites
        shell: pwsh
        run: |
          Write-Host "Running Pre-Requisites..." -ForegroundColor Cyan
          ./PreRequisites.ps1

      - name: Execute InputWach Test
        shell: pwsh
        run: |
          Write-Host "Starting DeIdentification Tests..." -ForegroundColor Cyan
          ./InputWatchTest.ps1

      - name: Execute REST API Test
        shell: pwsh
        run: |
          Write-Host "Starting REST API Test..." -ForegroundColor Cyan
          ./RestApiTest.ps1

      - name: Generate HTML Report
        shell: pwsh
        if: always()
        run: |
          Write-Host "Generating HTML Report..." -ForegroundColor Cyan
          ./Generate-Report.ps1

      - name: Upload HTML Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rest-api-test-report
          path: Reports.html
          retention-days: 30

      - name: Check Test Results
        if: always()
        shell: pwsh
        run: |
          if (Test-Path "Reports.html") {
            Write-Host "✓ Reports.html generated successfully" `
              -ForegroundColor Green
          } else {
            Write-Host "✗ Reports.html was not generated" `
              -ForegroundColor Red
            exit 1
          }
